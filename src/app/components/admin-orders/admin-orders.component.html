<!-- ============================================================ -->
<!-- ADMIN ORDERS — Order lookup with expandable detail view     -->
<!-- ============================================================ -->

<div class="admin-orders">
  <div class="page-header">
    <h1>Order Management</h1>
    <span class="order-count">{{ filteredOrders.length }} of {{ totalOrders }} orders</span>
  </div>

  @if (error) {
    <div class="alert alert-error">{{ error }}</div>
  }

  <!-- ── Quick Stats ──────────────────────────────────────── -->
  <div class="order-stats">
    <div class="mini-stat">
      <span class="mini-stat-value">{{ totalOrders }}</span>
      <span class="mini-stat-label">Total Orders</span>
    </div>
    <div class="mini-stat">
      <span class="mini-stat-value">{{ totalRevenue | currency }}</span>
      <span class="mini-stat-label">Revenue</span>
    </div>
    <div class="mini-stat">
      <span class="mini-stat-value">{{ pendingCount }}</span>
      <span class="mini-stat-label">Pending</span>
    </div>
    <div class="mini-stat">
      <span class="mini-stat-value">{{ shippedCount }}</span>
      <span class="mini-stat-label">In Transit</span>
    </div>
  </div>

  <!-- ── Search & Filter Toolbar ──────────────────────────── -->
  <div class="toolbar">
    <input
      type="text"
      class="search-input"
      placeholder="Search by order #, customer name, or email..."
      [(ngModel)]="searchTerm"
      (input)="applyFilter()"
    />
    <select
      class="status-select"
      [(ngModel)]="statusFilter"
      (change)="applyFilter()"
    >
      <option value="all">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="processing">Processing</option>
      <option value="shipped">Shipped</option>
      <option value="delivered">Delivered</option>
      <option value="cancelled">Cancelled</option>
    </select>
  </div>

  <!-- ── Orders Table ─────────────────────────────────────── -->
  @if (loading) {
    <div class="loading">Loading orders...</div>
  } @else if (filteredOrders.length === 0) {
    <div class="empty-state">
      <p>No orders found matching your search.</p>
    </div>
  } @else {
    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          @for (order of filteredOrders; track order.id) {
            <!-- Main row (clickable) -->
            <tr
              class="order-row"
              [class.expanded]="expandedOrderId === order.id"
              [class.cancelled-row]="order.status === 'cancelled'"
              (click)="toggleExpand(order.id)"
            >
              <td class="cell-order-num">{{ order.orderNumber }}</td>
              <td class="cell-customer">
                <span class="customer-name">{{ order.first_name }} {{ order.last_name }}</span>
                <span class="customer-email">{{ order.email }}</span>
              </td>
              <td class="cell-date">{{ formatDate(order.created_at) }}</td>
              <td class="cell-items">{{ order.items?.length || 0 }} item{{ (order.items?.length || 0) !== 1 ? 's' : '' }}</td>
              <td class="cell-total">{{ order.total | currency }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(order.status)">
                  {{ order.status }}
                </span>
              </td>
            </tr>

            <!-- Expanded detail row -->
            @if (expandedOrderId === order.id) {
              <tr class="detail-row">
                <td colspan="6">
                  <div class="order-detail">

                    <!-- Line Items -->
                    <div class="detail-section">
                      <h3>Order Items</h3>
                      <div class="items-list">
                        @for (item of order.items; track item.id) {
                          <div class="item-row">
                            <img [src]="item.image" [alt]="item.name" class="item-thumb" />
                            <div class="item-info">
                              <span class="item-name">{{ item.name }}</span>
                              <span class="item-meta">{{ item.category }} &middot; Qty: {{ item.quantity }}</span>
                            </div>
                            <span class="item-price">{{ item.price_at_purchase * item.quantity | currency }}</span>
                          </div>
                        }
                      </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="detail-section">
                      <h3>Cost Breakdown</h3>
                      <div class="cost-breakdown">
                        <div class="cost-row">
                          <span>Subtotal</span>
                          <span>{{ order.subtotal | currency }}</span>
                        </div>
                        <div class="cost-row">
                          <span>Tax (8.25%)</span>
                          <span>{{ order.tax | currency }}</span>
                        </div>
                        <div class="cost-row">
                          <span>Shipping &amp; Fees</span>
                          <span>{{ order.fees | currency }}</span>
                        </div>
                        <div class="cost-row cost-total">
                          <span>Total</span>
                          <span>{{ order.total | currency }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="detail-section">
                      <h3>Shipping Address</h3>
                      <p class="address-text">{{ order.shipping_address }}</p>
                    </div>

                    <!-- Status Actions -->
                    @if (getNextStatuses(order.status).length > 0) {
                      <div class="detail-section">
                        <h3>Update Status</h3>
                        <div class="status-actions">
                          @for (nextStatus of getNextStatuses(order.status); track nextStatus) {
                            <button
                              class="btn btn-sm"
                              [ngClass]="nextStatus === 'cancelled' ? 'btn-danger' : 'btn-primary'"
                              (click)="updateStatus(order, nextStatus); $event.stopPropagation()"
                            >
                              {{ nextStatus === 'cancelled' ? 'Cancel Order' : 'Mark as ' + nextStatus }}
                            </button>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  }
</div>
